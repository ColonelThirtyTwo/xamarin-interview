
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	
	<title>Average Age of Actors in a Movie</title>
	
	<link rel="stylesheet" type="text/css" href="./style.css">
	<link rel="stylesheet" type="text/css" href="./select2.css">
	
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/select2.min.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
</head>
<body>

<noscript>
	<h1>This app requires Javascript!</h1>
</noscript>

<div id="movie-searcher">
	<input type="text">
</div>

<div id="svg-canvas">
	<img id="loading-icon" src="./ajax-loader.gif" width="48" height="48" style="display: none;">
	<svg>
	</svg>
</div>

<script type="text/javascript">
"use strict";

(function() {
	// Some SVG settings
	var margin = {top: 20, right: 40, bottom: 30, left: 20},
	    width = 800 - margin.left - margin.right,
	    height = 600 - margin.top - margin.bottom;
	
	// Create an element to put graph elements in.
	var svg = d3.select("svg").append("g")
		.attr("transform", "translate("+margin.left+","+margin.top+")")
	;
	
	// Array of currently loaded actor data to be fed to d3
	var actorData = [];
	
	// Redraws the graph based on the data in actorData
	function redrawGraph() {
		var maxAge = d3.max(actorData, function(v) { return v.age; });
		var barSpacing = width / actorData.length;
		var barWidth = barSpacing * 0.8;
		
		// Y Scale
		var yScale = d3.scale.linear()
			.domain([0, maxAge || 1])
			.range([0, height]);
		
		// Do join
		var s_bar = svg.selectAll("g.bar").data(actorData, function(v) { return v.name; });
		s_bar.enter().append("g")
			.classed("bar", true)
			.append("rect")
				.attr("width", barWidth);
		
		s_bar
			.classed("failed", function(d) { return d.failed; })
			.attr("transform", function(d, i) {
				return "translate(" + (i*barSpacing) + "," + (height - yScale(d.age)) + ")"
			});
		s_bar.select("rect")
			.attr("height", function(d) { return yScale(d.age); });
		
		s_bar.exit().remove();
	}
	
	// Clears the graph, then fetches each actor's age and displays them in the graph.
	function reloadGraph(actors) {
		actorData = [];
		
		actors.forEach(function(actorName) {
			// Add actor entry
			var actor = {
				name: actorName,
				age: 0,
				fetched: false,
				failed: false,
			};
			actorData.push(actor);
			
			// Get each actor's age
			$.ajax({
				url: "http://en.wikipedia.org/w/api.php",
				jsonp: "callback",
				dataType: "jsonp",
				cache: true,
				data: {
					format: "json",
					action: "parse",
					page: actorName,
					redirects: true,
				},
				
				success: function(data) {
					// Convert to HTML fragment and scrape age
					var htmlStr = data.parse.text["*"];
					
					// Don't try to load a ton of images when we load the fragment.
					htmlStr = htmlStr.replace(/src=/g, "data-src=");
					htmlStr = htmlStr.replace(/srcset=/g, "data-srcset=");
					
					var content = $(htmlStr);
					
					var match = content.find(".ForceAgeToShow").text()
						.match(/\(age\s*(\d+)\)/i);
					var age = match && parseInt(match[1]);
					
					console.log(actorName, age);
					
					// Update actor and graph.
					actor.fetch = true;
					if(age)
						actor.age = age;
					else
						actor.failed = true;
					
					redrawGraph();
				},
			});
		});
		
		redrawGraph();
	}
	
	// Movie Selector
	$("#movie-searcher input").select2({
		placeholder: "Select a movie",
		minimumInputLength: 4,
		width: "100%",
		ajax: {
			url: "http://www.omdbapi.com/",
			dataType: "json",
			quietMillis: 250,
			cache: true,
			data: function(term, page) {
				return {
					s: term,
				};
			},
			results: function(data, page) {
				if(!("Search" in data))
					return {results: [], more: false};
				
				// OMDB likes to duplicate titles, so filter those out.
				var added = d3.set();
				var results = [];
				
				for(var i=0; i<data.Search.length; i++) {
					var entry = data.Search[i];
					if(!added.has(entry.Title)) {
						added.add(entry.Title);
						results.push({
							id: entry.Title,
							text: entry.Title + " ("+entry.Year+")",
						});
					}
				}
				
				return {
					results: results,
					more: false,
				};
			},
		}
	});
	
	$("#movie-searcher input").on("select2-selecting", function(e) {
		$("#loading-icon").show(100);
		$.getJSON("http://www.omdbapi.com/", {t: e.val}, function(data) {
			$("#loading-icon").hide(100);
			
			var actors = data.Actors;
			actors = actors.split(/, */);
			
			reloadGraph(actors);
		});
	});
})();	
</script>

</body>
</html>
