
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	
	<title>Average Age of Actors in a Movie</title>
	
	<link rel="stylesheet" type="text/css" href="./style.css">
	<link rel="stylesheet" type="text/css" href="./select2.css">
	
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/select2.min.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
</head>
<body>

<noscript>
	<h1>This app requires Javascript!</h1>
</noscript>

<div id="movie-searcher">
	<input type="text">
</div>

<div id="svg-canvas">
	<img id="loading-icon" src="./ajax-loader.gif" width="48" height="48" style="display: none;">
	<svg>
	</svg>
</div>

<script type="text/javascript">
(function() {
	/*var margin = {top: 20, right: 40, bottom: 30, left: 20},
	    width = 800 - margin.left - margin.right,
	    height = 600 - margin.top - margin.bottom;
	
	
	var svg = d3.select("svg").append("g")
		.attr("transform", "translate("+margin.left+","+margin.top+")")
	;*/
	
	// Clears the graph, then fetches each actor's age and displays them in the graph.
	function reloadGraph(actors) {
		actors.forEach(function(actor, i) {
			actor = actor.replace(" ", "_");
			
			/* Go through corsproxy to step around cross-site request restrictions */
			$.get("http://www.corsproxy.com/en.wikipedia.org/wiki/"+actor, function(data) {
				data = $(data);
				
				var match = data.find("table.infobox th:contains('Born') + td .ForceAgeToShow").text()
					.match(/\(age\s*(\d+)\)/i);
				console.log(actor, match && parseInt(match[1]));
			}, "html");
		});
	}
	
	// Movie Selector
	$("#movie-searcher input").select2({
		placeholder: "Select a movie",
		minimumInputLength: 4,
		width: "100%",
		ajax: {
			url: "http://www.omdbapi.com/",
			dataType: "json",
			quietMillis: 250,
			cache: true,
			data: function(term, page) {
				return {
					s: term,
				};
			},
			results: function(data, page) {
				if(!("Search" in data))
					return {results: [], more: false};
				
				// OMDB likes to duplicate titles, so filter those out.
				var added = d3.set();
				var results = [];
				
				for(var i=0; i<data.Search.length; i++) {
					var entry = data.Search[i];
					if(!added.has(entry.Title)) {
						added.add(entry.Title);
						results.push({
							id: entry.Title,
							text: entry.Title + " ("+entry.Year+")",
						});
					}
				}
				
				return {
					results: results,
					more: false,
				};
			},
		}
	});
	
	$("#movie-searcher input").on("select2-selecting", function(e) {
		$("#loading-icon").show(100);
		$.getJSON("http://www.omdbapi.com/", {t: e.val}, function(data) {
			$("#loading-icon").hide(100);
			
			var actors = data.Actors;
			actors = actors.split(/, */);
			
			reloadGraph(actors);
		});
	});
})();	
</script>

</body>
</html>
